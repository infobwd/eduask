<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบนิเทศการสอน</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Sarabun', 'Kanit', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .nav-tabs {
            display: flex;
            background: #f8fafc;
            border-bottom: 2px solid #e2e8f0;
        }

        .nav-tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            border: none;
            background: transparent;
        }

        .nav-tab:hover {
            background: #e2e8f0;
        }

        .nav-tab.active {
            background: #4f46e5;
            color: white;
        }

        .tab-content {
            padding: 30px;
        }

        .tab-pane {
            display: none;
        }

        .tab-pane.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #374151;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #4f46e5;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .evaluation-section {
            background: #f8fafc;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 20px;
            border: 1px solid #e2e8f0;
        }

        .evaluation-section h3 {
            color: #4f46e5;
            margin-bottom: 20px;
            font-size: 1.4rem;
            padding-bottom: 10px;
            border-bottom: 2px solid #4f46e5;
        }

        .evaluation-item {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }

        .evaluation-item .description {
            flex: 1;
            margin-right: 15px;
            font-size: 0.95rem;
        }

        .rating-group {
            display: flex;
            gap: 10px;
            margin-right: 15px;
        }

        .rating-group input[type="radio"] {
            margin: 0;
            width: auto;
        }

        .rating-group label {
            margin: 0;
            font-weight: normal;
            cursor: pointer;
        }

        .comment-input {
            width: 200px;
            padding: 8px;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            font-size: 14px;
        }

        .btn {
            display: inline-block;
            padding: 12px 24px;
            background: #4f46e5;
            color: white;
            text-decoration: none;
            border-radius: 8px;
            border: none;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn:hover {
            background: #3730a3;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #6b7280;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .btn-success {
            background: #10b981;
        }

        .btn-success:hover {
            background: #059669;
        }

        .file-upload {
            position: relative;
            display: inline-block;
        }

        .file-upload input[type="file"] {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .file-upload .btn {
            margin: 0;
        }

        .records-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .records-table th,
        .records-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }

        .records-table th {
            background: #f8fafc;
            font-weight: 600;
            color: #374151;
        }

        .records-table tr:hover {
            background: #f8fafc;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #6b7280;
        }

        .loading::after {
            content: "";
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #e2e8f0;
            border-radius: 50%;
            border-top-color: #4f46e5;
            animation: spin 1s ease-in-out infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .alert {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
            font-weight: 600;
        }

        .alert-success {
            background: #ecfdf5;
            color: #065f46;
            border: 1px solid #a7f3d0;
        }

        .alert-error {
            background: #fef2f2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }

        .signature-area {
            border: 2px dashed #e2e8f0;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: border-color 0.3s ease;
            background: #f8fafc;
        }

        .signature-area:hover {
            border-color: #4f46e5;
        }

        .signature-area.has-signature {
            border-color: #10b981;
            background: #ecfdf5;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .nav-tabs {
                flex-direction: column;
            }
            
            .evaluation-item {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .rating-group {
                margin: 10px 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ระบบนิเทศการสอน</h1>
            <p>แบบบันทึกการนิเทศการจัดการเรียนรู้และการจัดการชั้นเรียน</p>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('form')">บันทึกการนิเทศ</button>
            <button class="nav-tab" onclick="showTab('records')">ประวัติการนิเทศ</button>
            <button class="nav-tab" onclick="showTab('reports')">รายงาน</button>
        </div>

        <div class="tab-content">
            <!-- Form Tab -->
            <div id="form-tab" class="tab-pane active">
                <form id="supervisionForm">
                    <!-- Basic Information -->
                    <div class="evaluation-section">
                        <h3>ข้อมูลพื้นฐาน</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="visitNo">การนิเทศครั้งที่</label>
                                <input type="number" id="visitNo" name="visitNo" min="1" required>
                            </div>
                            <div class="form-group">
                                <label for="date">วันที่</label>
                                <input type="date" id="date" name="date" required>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="supervisorList">ผู้นิเทศ (ชื่อ-ตำแหน่ง)</label>
                                <textarea id="supervisorList" name="supervisorList" rows="3" placeholder="ระบุชื่อและตำแหน่งของผู้นิเทศทุกคน" required></textarea>
                            </div>
                            <div class="form-group">
                                <label for="superviseeName">ผู้รับการนิเทศ (ชื่อ-ตำแหน่ง)</label>
                                <input type="text" id="superviseeName" name="superviseeName" required>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="level">สอนระดับชั้น</label>
                                <input type="text" id="level" name="level" placeholder="เช่น ม.1, ป.3" required>
                            </div>
                            <div class="form-group">
                                <label for="subject">วิชา/กิจกรรม</label>
                                <input type="text" id="subject" name="subject" required>
                            </div>
                            <div class="form-group">
                                <label for="studentCount">จำนวนนักเรียน</label>
                                <input type="number" id="studentCount" name="studentCount" min="1" required>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="researchTopic">สอดคล้องกับการทำวิจัยในชั้นเรียนเรื่อง</label>
                            <input type="text" id="researchTopic" name="researchTopic" placeholder="ระบุหัวข้อวิจัย (ถ้ามี)">
                        </div>
                    </div>

                    <!-- Evaluation Sections -->
                    <div id="evaluationSections">
                        <!-- Categories will be loaded here -->
                    </div>

                    <!-- Additional Comments -->
                    <div class="evaluation-section">
                        <h3>ข้อเสนอแนะเพิ่มเติมจากคณะนิเทศ</h3>
                        <div class="form-group">
                            <textarea id="suggestion" name="suggestion" rows="4" placeholder="ข้อเสนอแนะ คำแนะนำ หรือข้อควรปรับปรุง"></textarea>
                        </div>
                    </div>

                    <!-- Signatures -->
                    <div class="evaluation-section">
                        <h3>ลายเซ็น</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label>ลายเซ็นผู้นิเทศ</label>
                                <div class="signature-area" id="supervisorSignature" onclick="handleSignature('supervisor')">
                                    <p>คลิกเพื่ออัปโหลดลายเซ็นหรือรูปภาพ</p>
                                    <input type="file" id="supervisorSignFile" accept="image/*,.pdf" style="display: none;" onchange="handleFileUpload('supervisor', this)">
                                </div>
                            </div>
                            <div class="form-group">
                                <label>ลายเซ็นผู้รับการนิเทศ</label>
                                <div class="signature-area" id="superviseeSignature" onclick="handleSignature('supervisee')">
                                    <p>คลิกเพื่ออัปโหลดลายเซ็นหรือรูปภาพ</p>
                                    <input type="file" id="superviseeSignFile" accept="image/*,.pdf" style="display: none;" onchange="handleFileUpload('supervisee', this)">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Submit Button -->
                    <div style="text-align: center; margin-top: 30px;">
                        <button type="submit" class="btn btn-success" id="submitBtn">
                            บันทึกข้อมูลการนิเทศ
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="resetForm()" style="margin-left: 15px;">
                            เคลียร์ฟอร์ม
                        </button>
                    </div>
                </form>
            </div>

            <!-- Records Tab -->
            <div id="records-tab" class="tab-pane">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>ประวัติการนิเทศ</h2>
                    <button class="btn" onclick="loadSupervisionRecords()">รีเฟรช</button>
                </div>
                <div id="recordsContainer">
                    <div class="loading">กำลังโหลดข้อมูล...</div>
                </div>
            </div>

            <!-- Reports Tab -->
            <div id="reports-tab" class="tab-pane">
                <h2>รายงานและสถิติ</h2>
                <div class="form-row" style="margin-top: 20px;">
                    <div class="form-group">
                        <label for="reportType">ประเภทรายงาน</label>
                        <select id="reportType">
                            <option value="summary">สรุปผลการนิเทศ</option>
                            <option value="teacher">รายงานตามครู</option>
                            <option value="subject">รายงานตามวิชา</option>
                            <option value="period">รายงานตามช่วงเวลา</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="dateFrom">จากวันที่</label>
                        <input type="date" id="dateFrom">
                    </div>
                    <div class="form-group">
                        <label for="dateTo">ถึงวันที่</label>
                        <input type="date" id="dateTo">
                    </div>
                </div>
                <div style="margin-top: 20px;">
                    <button class="btn" onclick="generateReport()">สร้างรายงาน</button>
                    <button class="btn btn-secondary" onclick="exportToExcel()">ส่งออก Excel</button>
                </div>
                <div id="reportContainer" style="margin-top: 30px;">
                    <!-- Report content will be displayed here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Alert Container -->
    <div id="alertContainer" style="position: fixed; top: 20px; right: 20px; z-index: 1000; max-width: 400px;"></div>

    <script>
        // Configuration
        const CONFIG = {
            GAS_URL: 'YOUR_GOOGLE_APPS_SCRIPT_WEB_APP_URL', // Replace with your GAS Web App URL
            LINE_LIFF_ID: '2006490627-lnx8yPYJ'
        };

        // Global variables
        let masterItems = [];
        let currentSupervisionData = {};

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            loadMasterItems();
            setDefaultDate();
            initializeLIFF();
        });

        // LIFF Integration
        function initializeLIFF() {
            if (typeof liff !== 'undefined') {
                liff.init({
                    liffId: CONFIG.LINE_LIFF_ID
                }).then(() => {
                    console.log('LIFF initialized successfully');
                    if (liff.isLoggedIn()) {
                        liff.getProfile().then(profile => {
                            console.log('User profile:', profile);
                            document.getElementById('superviseeName').value = profile.displayName;
                        });
                    }
                }).catch((err) => {
                    console.log('LIFF initialization failed', err);
                });
            }
        }

        // Tab switching
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-pane').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all nav tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName + '-tab').classList.add('active');
            
            // Add active class to clicked nav tab
            event.target.classList.add('active');
            
            // Load data if needed
            if (tabName === 'records') {
                loadSupervisionRecords();
            }
        }

        // Load master evaluation items
        async function loadMasterItems() {
            try {
                showLoading('กำลังโหลดรายการประเมิน...');
                
                const response = await fetch(`${CONFIG.GAS_URL}?action=getMasterItems`);
                const result = await response.json();
                
                if (result.success) {
                    masterItems = result.data;
                    renderEvaluationSections();
                } else {
                    showAlert('เกิดข้อผิดพลาดในการโหลดรายการประเมิน: ' + result.error, 'error');
                }
            } catch (error) {
                console.error('Error loading master items:', error);
                showAlert('เกิดข้อผิดพลาดในการเชื่อมต่อ', 'error');
            } finally {
                hideLoading();
            }
        }

        // Render evaluation sections
        function renderEvaluationSections() {
            const container = document.getElementById('evaluationSections');
            const categories = {
                'ก': 'ด้านการเตรียมความพร้อมของครู',
                'ข': 'ด้านทักษะ/กระบวนการจัดการเรียนรู้ของครู',
                'ค': 'ด้านผู้เรียน',
                'ง': 'บรรยากาศในชั้นเรียน'
            };

            container.innerHTML = '';

            Object.keys(categories).forEach(categoryKey => {
                const categoryItems = masterItems.filter(item => item.Category === categoryKey);
                
                if (categoryItems.length > 0) {
                    const section = document.createElement('div');
                    section.className = 'evaluation-section';
                    section.innerHTML = `
                        <h3>${categoryKey}. ${categories[categoryKey]}</h3>
                        ${categoryItems.map(item => `
                            <div class="evaluation-item">
                                <div class="description">
                                    ${item.ItemNo}. ${item.Description}
                                </div>
                                <div class="rating-group">
                                    ${[5, 4, 3, 2, 1].map(score => `
                                        <label>
                                            <input type="radio" name="score_${categoryKey}_${item.ItemNo}" value="${score}" required>
                                            ${score}
                                        </label>
                                    `).join('')}
                                </div>
                                <input type="text" class="comment-input" placeholder="ความคิดเห็น" 
                                       id="comment_${categoryKey}_${item.ItemNo}">
                            </div>
                        `).join('')}
                    `;
                    container.appendChild(section);
                }
            });
        }

        // Set default date to today
        function setDefaultDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('date').value = today;
        }

        // Handle signature upload
        function handleSignature(type) {
            document.getElementById(type + 'SignFile').click();
        }

        // Handle file upload
        async function handleFileUpload(type, fileInput) {
            const file = fileInput.files[0];
            if (!file) return;

            const signatureArea = document.getElementById(type + 'Signature');
            signatureArea.innerHTML = '<div class="loading">กำลังอัปโหลด...</div>';

            try {
                const base64 = await fileToBase64(file);
                
                const uploadData = {
                    action: 'uploadFile',
                    fileData: base64.split(',')[1],
                    fileName: `${type}_signature_${Date.now()}.${file.name.split('.').pop()}`,
                    mimeType: file.type
                };

                const response = await fetch(CONFIG.GAS_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(uploadData)
                });

                const result = await response.json();

                if (result.success) {
                    signatureArea.innerHTML = `
                        <p style="color: #10b981; font-weight: 600;">✓ ลายเซ็นอัปโหลดสำเร็จ</p>
                        <small>${result.fileName}</small>
                    `;
                    signatureArea.classList.add('has-signature');
                    
                    // Store file URL for form submission
                    currentSupervisionData[type + 'Sign'] = result.fileUrl;
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                console.error('Error uploading file:', error);
                signatureArea.innerHTML = '<p style="color: #ef4444;">เกิดข้อผิดพลาดในการอัปโหลด</p>';
                showAlert('เกิดข้อผิดพลาดในการอัปโหลดไฟล์: ' + error.message, 'error');
            }
        }

        // Convert file to base64
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }

        // Form submission
        document.getElementById('supervisionForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const submitBtn = document.getElementById('submitBtn');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = 'กำลังบันทึก...';
            submitBtn.disabled = true;

            try {
                const formData = new FormData(this);
                const data = Object.fromEntries(formData.entries());
                
                // Collect evaluation scores and comments
                const evaluations = [];
                masterItems.forEach(item => {
                    const scoreElement = document.querySelector(`input[name="score_${item.Category}_${item.ItemNo}"]:checked`);
                    const commentElement = document.getElementById(`comment_${item.Category}_${item.ItemNo}`);
                    
                    if (scoreElement) {
                        evaluations.push({
                            category: item.Category,
                            itemNo: item.ItemNo,
                            description: item.Description,
                            score: parseInt(scoreElement.value),
                            comment: commentElement.value || ''
                        });
                    }
                });

                // Add signatures if uploaded
                if (currentSupervisionData.supervisorSign) {
                    data.supervisorSign = currentSupervisionData.supervisorSign;
                }
                if (currentSupervisionData.superviseeSign) {
                    data.superviseeSign = currentSupervisionData.superviseeSign;
                }

                const submissionData = {
                    action: 'saveSupervision',
                    data: {
                        ...data,
                        evaluations: evaluations
                    }
                };

                const response = await fetch(CONFIG.GAS_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(submissionData)
                });

                const result = await response.json();

                if (result.success) {
                    showAlert(`บันทึกข้อมูลสำเร็จ! รหัสการนิเทศ: ${result.supervisionID}`, 'success');
                    
                    // Send LINE notification if LIFF is available
                    if (typeof liff !== 'undefined' && liff.isLoggedIn()) {
                        sendLineNotification(`บันทึกการนิเทศสำเร็จ\nรหัส: ${result.supervisionID}\nครู: ${data.superviseeName}\nวิชา: ${data.subject}`);
                    }
                    
                    // Reset form
                    resetForm();
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                console.error('Error saving supervision:', error);
                showAlert('เกิดข้อผิดพลาดในการบันทึกข้อมูล: ' + error.message, 'error');
            } finally {
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            }
        });

        // Send LINE notification
        function sendLineNotification(message) {
            if (typeof liff !== 'undefined' && liff.isLoggedIn()) {
                liff.sendMessages([{
                    type: 'text',
                    text: message
                }]).then(() => {
                    console.log('LINE message sent successfully');
                }).catch((err) => {
                    console.log('Error sending LINE message', err);
                });
            }
        }

        // Reset form
        function resetForm() {
            document.getElementById('supervisionForm').reset();
            setDefaultDate();
            
            // Reset signatures
            document.getElementById('supervisorSignature').innerHTML = '<p>คลิกเพื่ออัปโหลดลายเซ็นหรือรูปภาพ</p>';
            document.getElementById('superviseeSignature').innerHTML = '<p>คลิกเพื่ออัปโหลดลายเซ็นหรือรูปภาพ</p>';
            document.getElementById('supervisorSignature').classList.remove('has-signature');
            document.getElementById('superviseeSignature').classList.remove('has-signature');
            
            currentSupervisionData = {};
        }

        // Load supervision records
        async function loadSupervisionRecords() {
            const container = document.getElementById('recordsContainer');
            container.innerHTML = '<div class="loading">กำลังโหลดข้อมูล...</div>';

            try {
                const response = await fetch(`${CONFIG.GAS_URL}?action=getAllSupervisions`);
                const result = await response.json();

                if (result.success) {
                    renderSupervisionRecords(result.data);
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                console.error('Error loading records:', error);
                container.innerHTML = '<div class="alert alert-error">เกิดข้อผิดพลาดในการโหลดข้อมูล</div>';
            }
        }

        // Render supervision records
        function renderSupervisionRecords(records) {
            const container = document.getElementById('recordsContainer');
            
            if (records.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: #6b7280;">ยังไม่มีข้อมูลการนิเทศ</div>';
                return;
            }

            const table = `
                <table class="records-table">
                    <thead>
                        <tr>
                            <th>รหัสการนิเทศ</th>
                            <th>วันที่</th>
                            <th>ผู้รับการนิเทศ</th>
                            <th>วิชา</th>
                            <th>ระดับชั้น</th>
                            <th>การดำเนินการ</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${records.map(record => `
                            <tr>
                                <td>${record.SupervisionID}</td>
                                <td>${formatDate(record.Date)}</td>
                                <td>${record.SuperviseeName}</td>
                                <td>${record.Subject}</td>
                                <td>${record.Level}</td>
                                <td>
                                    <button class="btn" style="padding: 6px 12px; font-size: 14px;" 
                                            onclick="viewSupervisionDetail('${record.SupervisionID}')">
                                        ดูรายละเอียด
                                    </button>
                                    <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 14px; margin-left: 5px;" 
                                            onclick="generateSupervisionReport('${record.SupervisionID}')">
                                        รายงาน
                                    </button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            container.innerHTML = table;
        }

        // View supervision detail
        async function viewSupervisionDetail(supervisionID) {
            showLoading('กำลังโหลดรายละเอียด...');
            
            try {
                const response = await fetch(`${CONFIG.GAS_URL}?action=getSupervision&id=${supervisionID}`);
                const result = await response.json();

                if (result.success) {
                    showSupervisionDetailModal(result.data);
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                console.error('Error loading supervision detail:', error);
                showAlert('เกิดข้อผิดพลาดในการโหลดรายละเอียด: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // Show supervision detail modal
        function showSupervisionDetailModal(data) {
            const modalHTML = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; display: flex; align-items: center; justify-content: center;" onclick="this.remove()">
                    <div style="background: white; border-radius: 12px; padding: 30px; max-width: 800px; max-height: 80vh; overflow-y: auto; margin: 20px;" onclick="event.stopPropagation()">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h2>รายละเอียดการนิเทศ: ${data.main.SupervisionID}</h2>
                            <button onclick="this.closest('div[style*=\"position: fixed\"]').remove()" style="background: none; border: none; font-size: 24px; cursor: pointer;">&times;</button>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <h3>ข้อมูลพื้นฐาน</h3>
                            <p><strong>วันที่:</strong> ${formatDate(data.main.Date)}</p>
                            <p><strong>ผู้นิเทศ:</strong> ${data.main.SupervisorList}</p>
                            <p><strong>ผู้รับการนิเทศ:</strong> ${data.main.SuperviseeName}</p>
                            <p><strong>วิชา:</strong> ${data.main.Subject}</p>
                            <p><strong>ระดับชั้น:</strong> ${data.main.Level}</p>
                            <p><strong>จำนวนนักเรียน:</strong> ${data.main.StudentCount} คน</p>
                            ${data.main.ResearchTopic ? `<p><strong>หัวข้อวิจัย:</strong> ${data.main.ResearchTopic}</p>` : ''}
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <h3>ผลการประเมิน</h3>
                            ${data.evaluations.map(eval => `
                                <div style="margin-bottom: 10px; padding: 10px; background: #f8fafc; border-radius: 6px;">
                                    <strong>${eval.Category}.${eval.ItemNo}</strong> ${eval.Description}
                                    <br><span style="color: #4f46e5; font-weight: 600;">คะแนน: ${eval.Score}/5</span>
                                    ${eval.Comment ? `<br><em>ความคิดเห็น: ${eval.Comment}</em>` : ''}
                                </div>
                            `).join('')}
                        </div>
                        
                        ${data.main.Suggestion ? `
                            <div style="margin-bottom: 20px;">
                                <h3>ข้อเสนอแนะ</h3>
                                <p>${data.main.Suggestion}</p>
                            </div>
                        ` : ''}
                        
                        <div style="text-align: center;">
                            <button class="btn" onclick="generateSupervisionReport('${data.main.SupervisionID}')">
                                สร้างรายงาน PDF
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        // Generate supervision report
        async function generateSupervisionReport(supervisionID) {
            showLoading('กำลังสร้างรายงาน...');
            
            try {
                const response = await fetch(CONFIG.GAS_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'generateReport',
                        supervisionID: supervisionID
                    })
                });

                const result = await response.json();

                if (result.success) {
                    window.open(result.documentUrl, '_blank');
                    showAlert('สร้างรายงานสำเร็จ!', 'success');
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                console.error('Error generating report:', error);
                showAlert('เกิดข้อผิดพลาดในการสร้างรายงาน: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // Generate reports (from reports tab)
        function generateReport() {
            showAlert('ฟีเจอร์รายงานกำลังพัฒนา', 'success');
        }

        // Export to Excel
        function exportToExcel() {
            showAlert('ฟีเจอร์ส่งออก Excel กำลังพัฒนา', 'success');
        }

        // Utility functions
        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString('th-TH');
        }

        function showAlert(message, type = 'success') {
            const alertContainer = document.getElementById('alertContainer');
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            
            alertContainer.appendChild(alertDiv);
            
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }

        function showLoading(message = 'กำลังโหลด...') {
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'globalLoading';
            loadingDiv.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(255,255,255,0.9); z-index: 9999; 
                display: flex; align-items: center; justify-content: center;
                font-size: 18px; font-weight: 600; color: #4f46e5;
            `;
            loadingDiv.innerHTML = `<div class="loading">${message}</div>`;
            document.body.appendChild(loadingDiv);
        }

        function hideLoading() {
            const loadingDiv = document.getElementById('globalLoading');
            if (loadingDiv) {
                loadingDiv.remove();
            }
        }

        // LINE Integration - Share Target Picker
        function shareToLine() {
            if (typeof liff !== 'undefined' && liff.isLoggedIn()) {
                liff.shareTargetPicker([{
                    type: 'text',
                    text: 'ระบบนิเทศการสอนออนไลน์\nสามารถใช้งานได้ที่: ' + window.location.href
                }]).then(() => {
                    console.log('Share target picker opened');
                }).catch((err) => {
                    console.log('Error opening share target picker', err);
                });
            }
        }

        // PWA Support
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            deferredPrompt = e;
            showInstallPrompt();
        });

        function showInstallPrompt() {
            const installBanner = document.createElement('div');
            installBanner.style.cssText = `
                position: fixed; bottom: 20px; left: 20px; right: 20px; 
                background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%); 
                color: white; padding: 15px; border-radius: 12px; 
                box-shadow: 0 10px 25px rgba(0,0,0,0.2); z-index: 1000;
                display: flex; justify-content: space-between; align-items: center;
            `;
            installBanner.innerHTML = `
                <div>
                    <div style="font-weight: 600;">ติดตั้งแอป</div>
                    <div style="font-size: 14px; opacity: 0.9;">เพื่อการใช้งานที่สะดวกยิ่งขึ้น</div>
                </div>
                <div>
                    <button onclick="installApp()" style="background: white; color: #4f46e5; border: none; padding: 8px 16px; border-radius: 6px; font-weight: 600; margin-right: 10px; cursor: pointer;">ติดตั้ง</button>
                    <button onclick="this.parentElement.parentElement.remove()" style="background: transparent; color: white; border: 1px solid white; padding: 8px 16px; border-radius: 6px; cursor: pointer;">ไม่ใช่ตอนนี้</button>
                </div>
            `;
            document.body.appendChild(installBanner);
        }

        function installApp() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('User accepted the install prompt');
                    }
                    deferredPrompt = null;
                });
            }
        }

        // Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then((registration) => {
                        console.log('SW registered: ', registration);
                    })
                    .catch((registrationError) => {
                        console.log('SW registration failed: ', registrationError);
                    });
            });
        }

        // Auto-save draft functionality
        let autoSaveTimer;
        function startAutoSave() {
            clearTimeout(autoSaveTimer);
            autoSaveTimer = setTimeout(() => {
                saveDraft();
            }, 30000); // Auto-save every 30 seconds
        }

        function saveDraft() {
            const formData = new FormData(document.getElementById('supervisionForm'));
            const draftData = Object.fromEntries(formData.entries());
            
            // Add evaluation scores
            masterItems.forEach(item => {
                const scoreElement = document.querySelector(`input[name="score_${item.Category}_${item.ItemNo}"]:checked`);
                const commentElement = document.getElementById(`comment_${item.Category}_${item.ItemNo}`);
                
                if (scoreElement) {
                    draftData[`score_${item.Category}_${item.ItemNo}`] = scoreElement.value;
                }
                if (commentElement && commentElement.value) {
                    draftData[`comment_${item.Category}_${item.ItemNo}`] = commentElement.value;
                }
            });

            try {
                const draftKey = 'supervision_draft_' + new Date().toDateString();
                sessionStorage.setItem(draftKey, JSON.stringify({
                    data: draftData,
                    timestamp: new Date().toISOString()
                }));
                console.log('Draft saved automatically');
            } catch (error) {
                console.log('Could not save draft:', error);
            }
        }

        function loadDraft() {
            try {
                const draftKey = 'supervision_draft_' + new Date().toDateString();
                const draftStr = sessionStorage.getItem(draftKey);
                
                if (draftStr) {
                    const draft = JSON.parse(draftStr);
                    const draftAge = new Date() - new Date(draft.timestamp);
                    
                    // Only load draft if it's less than 24 hours old
                    if (draftAge < 24 * 60 * 60 * 1000) {
                        if (confirm('พบข้อมูลแบบร่างที่บันทึกไว้ ต้องการโหลดข้อมูลนี้หรือไม่?')) {
                            Object.keys(draft.data).forEach(key => {
                                const element = document.getElementById(key) || 
                                              document.querySelector(`input[name="${key}"]`) ||
                                              document.querySelector(`textarea[name="${key}"]`) ||
                                              document.querySelector(`select[name="${key}"]`);
                                
                                if (element) {
                                    if (element.type === 'radio') {
                                        const radioBtn = document.querySelector(`input[name="${key}"][value="${draft.data[key]}"]`);
                                        if (radioBtn) radioBtn.checked = true;
                                    } else {
                                        element.value = draft.data[key];
                                    }
                                }
                            });
                            showAlert('โหลดข้อมูลแบบร่างสำเร็จ', 'success');
                        }
                    }
                }
            } catch (error) {
                console.log('Could not load draft:', error);
            }
        }

        // Add event listeners for auto-save
        document.addEventListener('DOMContentLoaded', function() {
            // Load draft on page load
            setTimeout(loadDraft, 1000);
            
            // Start auto-save when user starts typing
            document.getElementById('supervisionForm').addEventListener('input', startAutoSave);
            document.getElementById('supervisionForm').addEventListener('change', startAutoSave);
        });

        // Advanced search and filter functionality
        function searchRecords() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const rows = document.querySelectorAll('.records-table tbody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        }

        function filterByDateRange() {
            const fromDate = document.getElementById('filterFromDate').value;
            const toDate = document.getElementById('filterToDate').value;
            const rows = document.querySelectorAll('.records-table tbody tr');
            
            rows.forEach(row => {
                const dateCell = row.cells[1].textContent;
                const rowDate = new Date(dateCell);
                
                let show = true;
                if (fromDate && rowDate < new Date(fromDate)) show = false;
                if (toDate && rowDate > new Date(toDate)) show = false;
                
                row.style.display = show ? '' : 'none';
            });
        }

        // Print functionality
        function printSupervisionForm() {
            const printWindow = window.open('', '_blank');
            const formHTML = document.getElementById('supervisionForm').outerHTML;
            
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>แบบฟอร์มการนิเทศ</title>
                    <style>
                        body { font-family: 'Sarabun', sans-serif; margin: 20px; }
                        .form-group { margin-bottom: 15px; }
                        .form-group label { font-weight: bold; display: block; margin-bottom: 5px; }
                        .form-group input, .form-group select, .form-group textarea { 
                            width: 100%; padding: 8px; border: 1px solid #ddd; 
                        }
                        .evaluation-section { border: 1px solid #ddd; padding: 15px; margin: 10px 0; }
                        .evaluation-item { margin: 10px 0; padding: 10px; border-bottom: 1px solid #eee; }
                        @media print { 
                            .btn { display: none; }
                            .nav-tabs { display: none; }
                        }
                    </style>
                </head>
                <body>
                    <h1>แบบบันทึกการนิเทศการจัดการเรียนรู้และการจัดการชั้นเรียน</h1>
                    ${formHTML}
                </body>
                </html>
            `);
            
            printWindow.document.close();
            printWindow.focus();
            setTimeout(() => {
                printWindow.print();
                printWindow.close();
            }, 250);
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey || e.metaKey) {
                switch(e.key) {
                    case 's':
                        e.preventDefault();
                        document.getElementById('supervisionForm').dispatchEvent(new Event('submit'));
                        break;
                    case 'p':
                        e.preventDefault();
                        printSupervisionForm();
                        break;
                    case 'r':
                        e.preventDefault();
                        loadSupervisionRecords();
                        break;
                }
            }
        });

        // Offline support
        window.addEventListener('online', function() {
            showAlert('กลับมาออนไลน์แล้ว', 'success');
        });

        window.addEventListener('offline', function() {
            showAlert('กำลังใช้งานแบบออฟไลน์', 'error');
        });

        // Performance monitoring
        window.addEventListener('load', function() {
            if ('performance' in window) {
                const loadTime = performance.timing.loadEventEnd - performance.timing.navigationStart;
                console.log('Page load time:', loadTime + 'ms');
                
                if (loadTime > 3000) {
                    console.warn('Slow page load detected');
                }
            }
        });

        // Error boundary
        window.addEventListener('error', function(e) {
            console.error('Global error:', e.error);
            showAlert('เกิดข้อผิดพลาดในระบบ กรุณาลองใหม่อีกครั้ง', 'error');
        });

        window.addEventListener('unhandledrejection', function(e) {
            console.error('Unhandled promise rejection:', e.reason);
            showAlert('เกิดข้อผิดพลาดในการประมวลผล กรุณาลองใหม่อีกครั้ง', 'error');
        });

        // Theme switcher (optional)
        function toggleTheme() {
            document.body.classList.toggle('dark-theme');
            localStorage.setItem('theme', document.body.classList.contains('dark-theme') ? 'dark' : 'light');
        }

        // Load saved theme
        document.addEventListener('DOMContentLoaded', function() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-theme');
            }
        });

        // Add CSS for dark theme
        const darkThemeCSS = `
            .dark-theme {
                --bg-color: #1a1a1a;
                --text-color: #ffffff;
                --card-bg: #2d2d2d;
                --border-color: #404040;
            }
            
            .dark-theme .container {
                background: var(--card-bg);
                color: var(--text-color);
            }
            
            .dark-theme .evaluation-section {
                background: var(--bg-color);
                border-color: var(--border-color);
            }
        `;

        // Inject dark theme CSS
        const styleSheet = document.createElement('style');
        styleSheet.textContent = darkThemeCSS;
        document.head.appendChild(styleSheet);

        // Accessibility improvements
        function improveAccessibility() {
            // Add ARIA labels
            document.querySelectorAll('input[required]').forEach(input => {
                input.setAttribute('aria-required', 'true');
            });
            
            // Add focus management
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Tab') {
                    // Ensure visible focus indicators
                    const activeElement = document.activeElement;
                    if (activeElement) {
                        activeElement.style.outline = '2px solid #4f46e5';
                    }
                }
            });
        }

        // Initialize accessibility on load
        document.addEventListener('DOMContentLoaded', improveAccessibility);

        // Export functions for testing
        if (typeof module !== 'undefined' && module.exports) {
            module.exports = {
                showAlert,
                formatDate,
                generateSupervisionID: () => CONFIG.GAS_URL // Mock for testing
            };
        }
    </script>

    <!-- LINE LIFF SDK -->
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    
    <!-- Service Worker for PWA -->
    <script>
        // Service Worker code will be generated separately
        const swCode = `
            const CACHE_NAME = 'supervision-app-v1';
            const urlsToCache = [
                '/',
                '/index.html',
                '/manifest.json'
            ];

            self.addEventListener('install', function(event) {
                event.waitUntil(
                    caches.open(CACHE_NAME)
                        .then(function(cache) {
                            return cache.addAll(urlsToCache);
                        })
                );
            });

            self.addEventListener('fetch', function(event) {
                event.respondWith(
                    caches.match(event.request)
                        .then(function(response) {
                            if (response) {
                                return response;
                            }
                            return fetch(event.request);
                        }
                    )
                );
            });
        `;
        
        // Create service worker file dynamically
        if ('serviceWorker' in navigator) {
            const blob = new Blob([swCode], { type: 'application/javascript' });
            const swUrl = URL.createObjectURL(blob);
            
            navigator.serviceWorker.register(swUrl)
                .then(registration => console.log('SW registered'))
                .catch(error => console.log('SW registration failed'));
        }
    </script>

    <!-- PWA Manifest -->
    <script>
        const manifest = {
            name: "ระบบนิเทศการสอน",
            short_name: "นิเทศการสอน",
            description: "แบบบันทึกการนิเทศการจัดการเรียนรู้และการจัดการชั้นเรียน",
            start_url: "/",
            display: "standalone",
            background_color: "#ffffff",
            theme_color: "#4f46e5",
            icons: [
                {
                    src: "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTkyIiBoZWlnaHQ9IjE5MiIgdmlld0JveD0iMCAwIDE5MiAxOTIiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHJlY3Qgd2lkdGg9IjE5MiIgaGVpZ2h0PSIxOTIiIHJ4PSIzMiIgZmlsbD0iIzRmNDZlNSIvPjx0ZXh0IHg9Ijk2IiB5PSIxMTAiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSI2MCIgZmlsbD0id2hpdGUiIHRleHQtYW5jaG9yPSJtaWRkbGUiPuC4meC4tOC5gOC4l+C4qDwvdGV4dD48L3N2Zz4=",
                    sizes: "192x192",
                    type: "image/svg+xml"
                }
            ]
        };
        
        const manifestBlob = new Blob([JSON.stringify(manifest)], { type: 'application/json' });
        const manifestUrl = URL.createObjectURL(manifestBlob);
        
        const linkElement = document.createElement('link');
        linkElement.rel = 'manifest';
        linkElement.href = manifestUrl;
        document.head.appendChild(linkElement);
    </script>
</body>
</html>
