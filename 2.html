<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบนิเทศการสอน</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts - Kanit -->
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <!-- LINE LIFF SDK -->
    <script src="https://static.line-scdn.net/liff/edge/versions/2.22.3/liff.js"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        * {
            font-family: 'Kanit', sans-serif;
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .card-shadow {
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        
        .upload-area {
            transition: all 0.3s ease;
        }
        
        .upload-area:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 35px -5px rgba(0, 0, 0, 0.15);
        }
        
        .file-preview {
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .status-online {
            background: #10b981;
            color: white;
        }
        
        .status-offline {
            background: #ef4444;
            color: white;
        }
        
        .status-connecting {
            background: #f59e0b;
            color: white;
        }
        
        .pulse {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px -5px rgba(102, 126, 234, 0.4);
        }
        
        .category-tag {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            margin: 2px;
        }
        
        .floating-action {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            cursor: pointer;
            box-shadow: 0 8px 20px -5px rgba(102, 126, 234, 0.5);
            transition: all 0.3s ease;
            z-index: 1000;
        }
        
        .floating-action:hover {
            transform: scale(1.1);
            box-shadow: 0 12px 30px -5px rgba(102, 126, 234, 0.7);
        }
        
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
        
        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s ease;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Connection Status -->
    <div id="connectionStatus" class="connection-status status-connecting">
        <i class="fas fa-wifi"></i>
        <span>กำลังเชื่อมต่อ...</span>
    </div>
    
    <!-- Header -->
    <header class="gradient-bg text-white py-6">
        <div class="container mx-auto px-4">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold">ระบบนิเทศการสอน</h1>
                    <p class="text-blue-100 mt-2">จัดการเอกสารและสื่อการสอนอย่างมีประสิทธิภาพ</p>
                </div>
                <div class="flex items-center gap-4">
                    <button id="liffConnectBtn" class="bg-white/20 hover:bg-white/30 px-4 py-2 rounded-lg transition-colors">
                        <i class="fab fa-line mr-2"></i>
                        เชื่อมต่อ LINE
                    </button>
                    <button id="settingsBtn" class="bg-white/20 hover:bg-white/30 p-2 rounded-lg transition-colors">
                        <i class="fas fa-cog"></i>
                    </button>
                </div>
            </div>
        </div>
    </header>
    
    <!-- Main Content -->
    <main class="container mx-auto px-4 py-8">
        <!-- Upload Section -->
        <div class="bg-white rounded-xl card-shadow p-6 mb-8">
            <h2 class="text-2xl font-semibold text-gray-800 mb-6">
                <i class="fas fa-cloud-upload-alt mr-3 text-blue-600"></i>
                อัปโหลดไฟล์
            </h2>
            
            <div id="uploadArea" class="upload-area border-2 border-dashed border-gray-300 rounded-xl p-8 text-center cursor-pointer hover:border-blue-500 hover:bg-blue-50/50">
                <i class="fas fa-file-upload text-4xl text-gray-400 mb-4"></i>
                <p class="text-lg text-gray-600 mb-2">ลากไฟล์มาวางที่นี่ หรือคลิกเพื่อเลือกไฟล์</p>
                <p class="text-sm text-gray-500">รองรับ: PDF, Word, รูปภาพ (สูงสุด 50MB)</p>
                <input type="file" id="fileInput" class="hidden" multiple accept=".pdf,.doc,.docx,.jpg,.jpeg,.png,.gif">
            </div>
            
            <!-- File Preview Area -->
            <div id="filePreview" class="mt-6 hidden">
                <h3 class="text-lg font-semibold mb-4">ไฟล์ที่เลือก</h3>
                <div id="fileList" class="space-y-3"></div>
                
                <div class="mt-6 flex gap-4">
                    <button id="uploadBtn" class="btn-primary text-white px-6 py-3 rounded-lg flex items-center gap-2 disabled:opacity-50">
                        <i class="fas fa-upload"></i>
                        อัปโหลดไฟล์
                    </button>
                    <button id="clearBtn" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-lg flex items-center gap-2">
                        <i class="fas fa-trash"></i>
                        ล้างทั้งหมด
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Files Grid -->
        <div class="bg-white rounded-xl card-shadow p-6">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-semibold text-gray-800">
                    <i class="fas fa-folder-open mr-3 text-blue-600"></i>
                    ไฟล์ทั้งหมด
                </h2>
                <div class="flex items-center gap-4">
                    <div class="relative">
                        <input type="text" id="searchInput" placeholder="ค้นหาไฟล์..." class="pl-10 pr-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                    </div>
                    <select id="categoryFilter" class="px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">ทุกหมวดหมู่</option>
                    </select>
                </div>
            </div>
            
            <div id="filesGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Files will be loaded here -->
            </div>
            
            <div id="loadingFiles" class="text-center py-8">
                <i class="fas fa-spinner fa-spin text-2xl text-gray-400"></i>
                <p class="text-gray-500 mt-2">กำลังโหลดไฟล์...</p>
            </div>
            
            <div id="noFiles" class="text-center py-8 hidden">
                <i class="fas fa-folder-open text-4xl text-gray-400 mb-4"></i>
                <p class="text-gray-500">ยังไม่มีไฟล์ในระบบ</p>
            </div>
        </div>
    </main>
    
    <!-- Floating Action Button -->
    <button id="floatingBtn" class="floating-action">
        <i class="fas fa-plus"></i>
    </button>
    
    <!-- Upload Modal -->
    <div id="uploadModal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-semibold">อัปโหลดไฟล์</h3>
                <button id="closeModal" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <div id="uploadProgress" class="hidden mb-6">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-sm text-gray-600">กำลังอัปโหลด...</span>
                    <span id="progressText" class="text-sm text-gray-600">0%</span>
                </div>
                <div class="progress-bar">
                    <div id="progressFill" class="progress-fill" style="width: 0%"></div>
                </div>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">หมวดหมู่</label>
                    <select id="categorySelect" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">เลือกหมวดหมู่...</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">คำอธิบาย</label>
                    <textarea id="descriptionInput" rows="3" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="เพิ่มคำอธิบายไฟล์..."></textarea>
                </div>
                
                <div class="flex gap-4">
                    <button id="confirmUpload" class="btn-primary text-white px-6 py-2 rounded-lg flex-1">
                        <i class="fas fa-upload mr-2"></i>
                        อัปโหลด
                    </button>
                    <button id="cancelUpload" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg flex-1">
                        <i class="fas fa-times mr-2"></i>
                        ยกเลิก
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- File Detail Modal -->
    <div id="fileDetailModal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-semibold">รายละเอียดไฟล์</h3>
                <button id="closeDetailModal" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <div id="fileDetailContent">
                <!-- File details will be loaded here -->
            </div>
        </div>
    </div>

    <script>
        // ==================== CONFIGURATION ====================
        const CONFIG = {
            SCRIPT_URL: 'YOUR_SCRIPT_URL_HERE', // Replace with your Apps Script Web App URL
            LIFF_ID: 'YOUR_LIFF_ID_HERE', // Replace with your LIFF ID
            MAX_FILE_SIZE: 50 * 1024 * 1024, // 50MB
            ALLOWED_TYPES: ['image/jpeg', 'image/png', 'image/gif', 'application/pdf', 'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'],
            TIMEOUT: 30000, // 30 seconds
            RETRY_COUNT: 3
        };

        // ==================== API CLIENT CLASS ====================
        class ApiClient {
            constructor(baseUrl) {
                this.baseUrl = baseUrl;
                this.timeout = CONFIG.TIMEOUT;
                this.retryCount = CONFIG.RETRY_COUNT;
                this.connectionStatus = 'connecting';
                this.updateConnectionStatus();
            }

            async request(action, params = {}, useJsonp = true) {
                const url = new URL(this.baseUrl);
                url.searchParams.append('action', action);
                
                Object.keys(params).forEach(key => {
                    url.searchParams.append(key, params[key]);
                });

                let attempt = 0;
                while (attempt < this.retryCount) {
                    try {
                        if (useJsonp) {
                            const response = await this.jsonpRequest(url.toString());
                            this.setConnectionStatus('online');
                            return response;
                        } else {
                            const response = await this.jsonRequest(url.toString());
                            this.setConnectionStatus('online');
                            return response;
                        }
                    } catch (error) {
                        attempt++;
                        console.warn(`Request attempt ${attempt} failed:`, error);
                        
                        if (attempt < this.retryCount) {
                            await this.delay(1000 * attempt);
                        }
                        
                        // Try fallback to JSON if JSONP fails
                        if (useJsonp && attempt === this.retryCount) {
                            console.log('JSONP failed, trying JSON fallback...');
                            return this.request(action, params, false);
                        }
                    }
                }
                
                this.setConnectionStatus('offline');
                throw new Error('Request failed after all retries');
            }

            jsonpRequest(url) {
                return new Promise((resolve, reject) => {
                    const callback = 'callback_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                    const script = document.createElement('script');
                    const timeout = setTimeout(() => {
                        cleanup();
                        reject(new Error('JSONP request timeout'));
                    }, this.timeout);

                    const cleanup = () => {
                        clearTimeout(timeout);
                        document.head.removeChild(script);
                        delete window[callback];
                    };

                    window[callback] = (data) => {
                        cleanup();
                        resolve(data);
                    };

                    script.src = url + '&callback=' + callback;
                    script.onerror = () => {
                        cleanup();
                        reject(new Error('JSONP script load error'));
                    };

                    document.head.appendChild(script);
                });
            }

            async jsonRequest(url) {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), this.timeout);

                try {
                    const response = await fetch(url, {
                        signal: controller.signal,
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json',
                        }
                    });

                    clearTimeout(timeoutId);

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    return await response.json();
                } catch (error) {
                    clearTimeout(timeoutId);
                    throw error;
                }
            }

            setConnectionStatus(status) {
                this.connectionStatus = status;
                this.updateConnectionStatus();
            }

            updateConnectionStatus() {
                const statusElement = document.getElementById('connectionStatus');
                const statusText = statusElement.querySelector('span');
                const statusIcon = statusElement.querySelector('i');

                statusElement.className = 'connection-status';
                
                switch (this.connectionStatus) {
                    case 'online':
                        statusElement.classList.add('status-online');
                        statusText.textContent = 'เชื่อมต่อแล้ว';
                        statusIcon.className = 'fas fa-wifi';
                        break;
                    case 'offline':
                        statusElement.classList.add('status-offline');
                        statusText.textContent = 'ขาดการเชื่อมต่อ';
                        statusIcon.className = 'fas fa-wifi-slash';
                        break;
                    case 'connecting':
                        statusElement.classList.add('status-connecting', 'pulse');
                        statusText.textContent = 'กำลังเชื่อมต่อ...';
                        statusIcon.className = 'fas fa-sync fa-spin';
                        break;
                }
            }

            delay(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }

            async ping() {
                return this.request('ping');
            }

            async uploadFile(fileData) {
                return this.request('upload', fileData);
            }

            async getFiles() {
                return this.request('getFiles');
            }

            async getCategories() {
                return this.request('getCategories');
            }

            async incrementShare(fileId) {
                return this.request('incrementShare', { fileId });
            }
        }

        // ==================== FILE UPLOAD MANAGER ====================
        class FileUploadManager {
            constructor(apiClient) {
                this.apiClient = apiClient;
                this.selectedFiles = [];
                this.categories = [];
                this.initializeEventListeners();
                this.loadCategories();
            }

            initializeEventListeners() {
                const fileInput = document.getElementById('fileInput');
                const uploadArea = document.getElementById('uploadArea');
                const uploadBtn = document.getElementById('uploadBtn');
                const clearBtn = document.getElementById('clearBtn');
                const floatingBtn = document.getElementById('floatingBtn');

                // File input change
                fileInput.addEventListener('change', (e) => {
                    this.handleFileSelect(e.target.files);
                });

                // Drag and drop
                uploadArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    uploadArea.classList.add('border-blue-500', 'bg-blue-50');
                });

                uploadArea.addEventListener('dragleave', (e) => {
                    e.preventDefault();
                    uploadArea.classList.remove('border-blue-500', 'bg-blue-50');
                });

                uploadArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    uploadArea.classList.remove('border-blue-500', 'bg-blue-50');
                    this.handleFileSelect(e.dataTransfer.files);
                });

                // Click to select files
                uploadArea.addEventListener('click', () => {
                    fileInput.click();
                });

                // Upload button
                uploadBtn.addEventListener('click', () => {
                    this.uploadFiles();
                });

                // Clear button
                clearBtn.addEventListener('click', () => {
                    this.clearFiles();
                });

                // Floating action button
                floatingBtn.addEventListener('click', () => {
                    fileInput.click();
                });
            }

            async loadCategories() {
                try {
                    const response = await this.apiClient.getCategories();
                    if (response.success) {
                        this.categories = response.data;
                        this.populateCategorySelects();
                    }
                } catch (error) {
                    console.error('Error loading categories:', error);
                }
            }

            populateCategorySelects() {
                const categoryFilter = document.getElementById('categoryFilter');
                const categorySelect = document.getElementById('categorySelect');

                [categoryFilter, categorySelect].forEach(select => {
                    if (select) {
                        // Clear existing options (except first one)
                        while (select.children.length > 1) {
                            select.removeChild(select.lastChild);
                        }

                        // Add category options
                        this.categories.forEach(category => {
                            const option = document.createElement('option');
                            option.value = category.Name;
                            option.textContent = category.Name;
                            select.appendChild(option);
                        });
                    }
                });
            }

            handleFileSelect(files) {
                const fileArray = Array.from(files);
                const validFiles = [];

                fileArray.forEach(file => {
                    if (this.validateFile(file)) {
                        validFiles.push(file);
                    }
                });

                if (validFiles.length > 0) {
                    this.selectedFiles = [...this.selectedFiles, ...validFiles];
                    this.updateFilePreview();
                    this.showFilePreview();
                }
            }

            validateFile(file) {
                // Check file size
                if (file.size > CONFIG.MAX_FILE_SIZE) {
                    Swal.fire({
                        title: 'ไฟล์ใหญ่เกินไป',
                        text: `ไฟล์ ${file.name} มีขนาด ${(file.size / 1024 / 1024).toFixed(2)} MB เกินขนาดที่อนุญาต (50 MB)`,
                        icon: 'warning',
                        confirmButtonText: 'ตกลง'
                    });
                    return false;
                }

                // Check file type
                if (!CONFIG.ALLOWED_TYPES.includes(file.type)) {
                    Swal.fire({
                        title: 'ประเภทไฟล์ไม่รองรับ',
                        text: `ไฟล์ ${file.name} เป็นประเภทที่ไม่รองรับ`,
                        icon: 'warning',
                        confirmButtonText: 'ตกลง'
                    });
                    return false;
                }

                return true;
            }

            showFilePreview() {
                const filePreview = document.getElementById('filePreview');
                filePreview.classList.remove('hidden');
            }

            updateFilePreview() {
                const fileList = document.getElementById('fileList');
                fileList.innerHTML = '';

                this.selectedFiles.forEach((file, index) => {
                    const fileItem = document.createElement('div');
                    fileItem.className = 'file-preview bg-gray-50 p-4 rounded-lg flex items-center justify-between';
                    
                    const fileInfo = document.createElement('div');
                    fileInfo.className = 'flex items-center gap-3';
                    
                    const fileIcon = this.getFileIcon(file.type);
                    const fileSize = (file.size / 1024 / 1024).toFixed(2);
                    
                    fileInfo.innerHTML = `
                        <i class="${fileIcon} text-2xl text-blue-600"></i>
                        <div>
                            <div class="font-medium text-gray-800">${file.name}</div>
                            <div class="text-sm text-gray-500">${fileSize} MB • ${this.categorizeFile(file.name, file.type)}</div>
                        </div>
                    `;
                    
                    const removeBtn = document.createElement('button');
                    removeBtn.className = 'text-red-500 hover:text-red-700 p-2';
                    removeBtn.innerHTML = '<i class="fas fa-times"></i>';
                    removeBtn.addEventListener('click', () => {
                        this.removeFile(index);
                    });
                    
                    fileItem.appendChild(fileInfo);
                    fileItem.appendChild(removeBtn);
                    fileList.appendChild(fileItem);
                });
            }

            getFileIcon(mimeType) {
                if (mimeType.startsWith('image/')) return 'fas fa-image';
                if (mimeType === 'application/pdf') return 'fas fa-file-pdf';
                if (mimeType.includes('word')) return 'fas fa-file-word';
                return 'fas fa-file';
            }

            categorizeFile(fileName, mimeType) {
                const name = fileName.toLowerCase();
                
                if (mimeType.startsWith('image/')) return 'รูปภาพ';
                if (mimeType === 'application/pdf') return 'เอกสาร PDF';
                if (mimeType.includes('word')) return 'เอกสาร Word';
                if (name.includes('แผน') || name.includes('plan')) return 'แผนการสอน';
                if (name.includes('สื่อ') || name.includes('media')) return 'สื่อการสอน';
                if (name.includes('ประเมิน') || name.includes('assess')) return 'การประเมิน';
                
                return 'ทั่วไป';
            }

            removeFile(index) {
                this.selectedFiles.splice(index, 1);
                this.updateFilePreview();
                
                if (this.selectedFiles.length === 0) {
                    document.getElementById('filePreview').classList.add('hidden');
                }
            }

            clearFiles() {
                this.selectedFiles = [];
                document.getElementById('filePreview').classList.add('hidden');
                document.getElementById('fileInput').value = '';
            }

            async uploadFiles() {
                if (this.selectedFiles.length === 0) {
                    Swal.fire({
                        title: 'ไม่มีไฟล์ที่เลือก',
                        text: 'กรุณาเลือกไฟล์ที่ต้องการอัปโหลด',
                        icon: 'warning',
                        confirmButtonText: 'ตกลง'
                    });
                    return;
                }

                const uploadBtn = document.getElementById('uploadBtn');
                const originalText = uploadBtn.innerHTML;
                uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>กำลังอัปโหลด...';
                uploadBtn.disabled = true;

                try {
                    const results = [];
                    
                    for (let i = 0; i < this.selectedFiles.length; i++) {
                        const file = this.selectedFiles[i];
                        const fileData = await this.fileToBase64(file);
                        
                        const uploadData = {
                            fileName: file.name,
                            fileSize: file.size,
                            mimeType: file.type,
                            fileData: fileData.split(',')[1] // Remove data:... prefix
                        };
                        
                        const result = await this.apiClient.uploadFile(uploadData);
                        results.push(result);
                    }
                    
                    const successCount = results.filter(r => r.success).length;
                    const failCount = results.length - successCount;
                    
                    if (successCount > 0) {
                        Swal.fire({
                            title: 'อัปโหลดเสร็จสิ้น',
                            text: `อัปโหลดสำเร็จ ${successCount} ไฟล์${failCount > 0 ? ` (ล้มเหลว ${failCount} ไฟล์)` : ''}`,
                            icon: successCount === results.length ? 'success' : 'warning',
                            confirmButtonText: 'ตกลง'
                        });
                        
                        this.clearFiles();
                        fileManager.loadFiles(); // Refresh file list
                    } else {
                        Swal.fire({
                            title: 'อัปโหลดล้มเหลว',
                            text: 'ไม่สามารถอัปโหลดไฟล์ได้',
                            icon: 'error',
                            confirmButtonText: 'ตกลง'
                        });
                    }
                    
                } catch (error) {
                    console.error('Upload error:', error);
                    Swal.fire({
                        title: 'เกิดข้อผิดพลาด',
                        text: 'ไม่สามารถอัปโหลดไฟล์ได้ กรุณาลองใหม่อีกครั้ง',
                        icon: 'error',
                        confirmButtonText: 'ตกลง'
                    });
                } finally {
                    uploadBtn.innerHTML = originalText;
                    uploadBtn.disabled = false;
                }
            }

            fileToBase64(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = error => reject(error);
                });
            }
        }

        // ==================== FILE MANAGER ====================
        class FileManager {
            constructor(apiClient) {
                this.apiClient = apiClient;
                this.files = [];
                this.filteredFiles = [];
                this.initializeEventListeners();
                this.loadFiles();
            }

            initializeEventListeners() {
                const searchInput = document.getElementById('searchInput');
                const categoryFilter = document.getElementById('categoryFilter');

                searchInput.addEventListener('input', (e) => {
                    this.filterFiles();
                });

                categoryFilter.addEventListener('change', (e) => {
                    this.filterFiles();
                });
            }

            async loadFiles() {
                const loadingElement = document.getElementById('loadingFiles');
                const noFilesElement = document.getElementById('noFiles');
                const filesGrid = document.getElementById('filesGrid');

                loadingElement.classList.remove('hidden');
                noFilesElement.classList.add('hidden');
                filesGrid.innerHTML = '';

                try {
                    const response = await this.apiClient.getFiles();
                    if (response.success) {
                        this.files = response.data;
                        this.filteredFiles = [...this.files];
                        this.renderFiles();
                    } else {
                        throw new Error(response.error);
                    }
                } catch (error) {
                    console.error('Error loading files:', error);
                    Swal.fire({
                        title: 'เกิดข้อผิดพลาด',
                        text: 'ไม่สามารถโหลดรายการไฟล์ได้',
                        icon: 'error',
                        confirmButtonText: 'ตกลง'
                    });
                } finally {
                    loadingElement.classList.add('hidden');
                }
            }

            filterFiles() {
                const searchTerm = document.getElementById('searchInput').value.toLowerCase();
                const categoryFilter = document.getElementById('categoryFilter').value;

                this.filteredFiles = this.files.filter(file => {
                    const matchesSearch = file.Name.toLowerCase().includes(searchTerm);
                    const matchesCategory = !categoryFilter || file.Category === categoryFilter;
                    return matchesSearch && matchesCategory;
                });

                this.renderFiles();
            }

            renderFiles() {
                const filesGrid = document.getElementById('filesGrid');
                const noFilesElement = document.getElementById('noFiles');

                if (this.filteredFiles.length === 0) {
                    filesGrid.innerHTML = '';
                    noFilesElement.classList.remove('hidden');
                    return;
                }

                noFilesElement.classList.add('hidden');
                filesGrid.innerHTML = '';

                this.filteredFiles.forEach(file => {
                    const fileCard = this.createFileCard(file);
                    filesGrid.appendChild(fileCard);
                });
            }

            createFileCard(file) {
                const card = document.createElement('div');
                card.className = 'bg-white border rounded-lg p-4 hover:shadow-lg transition-shadow cursor-pointer';
                
                const fileIcon = this.getFileIcon(file.Type);
                const fileSize = (file.Size / 1024 / 1024).toFixed(2);
                const uploadDate = new Date(file.UploadDate).toLocaleDateString('th-TH');
                
                card.innerHTML = `
                    <div class="flex items-start gap-3">
                        <i class="${fileIcon} text-3xl text-blue-600"></i>
                        <div class="flex-1 min-w-0">
                            <h3 class="font-medium text-gray-800 truncate">${file.Name}</h3>
                            <p class="text-sm text-gray-500 mt-1">${fileSize} MB • ${uploadDate}</p>
                            <div class="category-tag bg-blue-100 text-blue-800 mt-2">${file.Category}</div>
                        </div>
                    </div>
                    <div class="flex items-center justify-between mt-4">
                        <div class="flex items-center gap-2 text-sm text-gray-500">
                            <i class="fas fa-share"></i>
                            <span>${file.Shares || 0} ครั้ง</span>
                        </div>
                        <div class="flex gap-2">
                            <button class="download-btn text-blue-600 hover:text-blue-800 p-1" data-file-id="${file.ID}">
                                <i class="fas fa-download"></i>
                            </button>
                            <button class="share-btn text-green-600 hover:text-green-800 p-1" data-file-id="${file.ID}">
                                <i class="fas fa-share"></i>
                            </button>
                            <button class="detail-btn text-gray-600 hover:text-gray-800 p-1" data-file-id="${file.ID}">
                                <i class="fas fa-info-circle"></i>
                            </button>
                        </div>
                    </div>
                `;

                // Add event listeners
                card.querySelector('.download-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.downloadFile(file);
                });

                card.querySelector('.share-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.shareFile(file);
                });

                card.querySelector('.detail-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.showFileDetail(file);
                });

                return card;
            }

            getFileIcon(mimeType) {
                if (mimeType.startsWith('image/')) return 'fas fa-image';
                if (mimeType === 'application/pdf') return 'fas fa-file-pdf';
                if (mimeType.includes('word')) return 'fas fa-file-word';
                return 'fas fa-file';
            }

            downloadFile(file) {
                window.open(file.DownloadURL, '_blank');
            }

            async shareFile(file) {
                try {
                    await this.apiClient.incrementShare(file.ID);
                    
                    if (liffManager.isLiffReady()) {
                        const flexMessage = generateFlexMessage(file);
                        await liffManager.shareToLine(flexMessage);
                    } else {
                        // Fallback to clipboard
                        await navigator.clipboard.writeText(file.URL);
                        Swal.fire({
                            title: 'คัดลอกลิงก์แล้ว',
                            text: 'ลิงก์ไฟล์ถูกคัดลอกไปยังคลิปบอร์ดแล้ว',
                            icon: 'success',
                            confirmButtonText: 'ตกลง'
                        });
                    }
                    
                    this.loadFiles(); // Refresh to update share count
                } catch (error) {
                    console.error('Share error:', error);
                    Swal.fire({
                        title: 'เกิดข้อผิดพลาด',
                        text: 'ไม่สามารถแชร์ไฟล์ได้',
                        icon: 'error',
                        confirmButtonText: 'ตกลง'
                    });
                }
            }

            showFileDetail(file) {
                const modal = document.getElementById('fileDetailModal');
                const content = document.getElementById('fileDetailContent');
                
                const fileSize = (file.Size / 1024 / 1024).toFixed(2);
                const uploadDate = new Date(file.UploadDate).toLocaleDateString('th-TH');
                
                content.innerHTML = `
                    <div class="space-y-4">
                        <div class="flex items-center gap-4">
                            <i class="${this.getFileIcon(file.Type)} text-4xl text-blue-600"></i>
                            <div>
                                <h4 class="text-lg font-semibold">${file.Name}</h4>
                                <p class="text-gray-500">${file.Category}</p>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">ขนาดไฟล์</label>
                                <p class="text-gray-900">${fileSize} MB</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">วันที่อัปโหลด</label>
                                <p class="text-gray-900">${uploadDate}</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">จำนวนการแชร์</label>
                                <p class="text-gray-900">${file.Shares || 0} ครั้ง</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">ประเภทไฟล์</label>
                                <p class="text-gray-900">${file.Type}</p>
                            </div>
                        </div>
                        
                        <div class="flex gap-4 pt-4">
                            <button class="btn-primary text-white px-6 py-2 rounded-lg flex-1" onclick="fileManager.downloadFile(${JSON.stringify(file).replace(/"/g, '&quot;')})">
                                <i class="fas fa-download mr-2"></i>ดาวน์โหลด
                            </button>
                            <button class="bg-green-500 hover:bg-green-600 text-white px-6 py-2 rounded-lg flex-1" onclick="fileManager.shareFile(${JSON.stringify(file).replace(/"/g, '&quot;')})">
                                <i class="fas fa-share mr-2"></i>แชร์
                            </button>
                        </div>
                    </div>
                `;
                
                modal.classList.remove('hidden');
            }
        }

        // ==================== LIFF MANAGER ====================
        class LiffManager {
            constructor() {
                this.liffId = CONFIG.LIFF_ID;
                this.isReady = false;
                this.initializeLiff();
            }

            async initializeLiff() {
                if (!this.liffId || this.liffId === 'YOUR_LIFF_ID_HERE') {
                    console.warn('LIFF ID not configured');
                    return;
                }

                try {
                    await liff.init({ liffId: this.liffId });
                    this.isReady = true;
                    this.updateLiffButton();
                } catch (error) {
                    console.error('LIFF initialization failed:', error);
                }
            }

            updateLiffButton() {
                const liffBtn = document.getElementById('liffConnectBtn');
                if (this.isReady) {
                    if (liff.isLoggedIn()) {
                        liffBtn.innerHTML = '<i class="fab fa-line mr-2"></i>เชื่อมต่อแล้ว';
                        liffBtn.classList.add('bg-green-500/20');
                    } else {
                        liffBtn.innerHTML = '<i class="fab fa-line mr-2"></i>เข้าสู่ระบบ LINE';
                        liffBtn.addEventListener('click', () => {
                            liff.login();
                        });
                    }
                } else {
                    liffBtn.innerHTML = '<i class="fab fa-line mr-2"></i>ไม่พร้อมใช้งาน';
                    liffBtn.disabled = true;
                }
            }

            isLiffReady() {
                return this.isReady && liff.isLoggedIn();
            }

            async shareToLine(flexMessage) {
                if (!this.isLiffReady()) {
                    throw new Error('LIFF not ready or user not logged in');
                }

                try {
                    if (liff.isApiAvailable('shareTargetPicker')) {
                        await liff.shareTargetPicker([flexMessage]);
                        Swal.fire({
                            title: 'แชร์สำเร็จ',
                            text: 'แชร์ไฟล์ผ่าน LINE เรียบร้อยแล้ว',
                            icon: 'success',
                            confirmButtonText: 'ตกลง'
                        });
                    } else {
                        throw new Error('Share Target Picker not available');
                    }
                } catch (error) {
                    console.error('LINE share error:', error);
                    throw error;
                }
            }
        }

        // ==================== FLEX MESSAGE GENERATOR ====================
        function generateFlexMessage(file) {
            const fileSize = (file.Size / 1024 / 1024).toFixed(2);
            const uploadDate = new Date(file.UploadDate).toLocaleDateString('th-TH');

            return {
                type: 'flex',
                altText: `ไฟล์: ${file.Name}`,
                contents: {
                    type: 'bubble',
                    header: {
                        type: 'box',
                        layout: 'vertical',
                        contents: [
                            {
                                type: 'text',
                                text: 'ระบบนิเทศการสอน',
                                weight: 'bold',
                                color: '#ffffff',
                                size: 'sm'
                            }
                        ],
                        backgroundColor: '#667eea',
                        paddingAll: '20px'
                    },
                    body: {
                        type: 'box',
                        layout: 'vertical',
                        contents: [
                            {
                                type: 'text',
                                text: file.Name,
                                weight: 'bold',
                                size: 'lg',
                                wrap: true
                            },
                            {
                                type: 'box',
                                layout: 'vertical',
                                margin: 'lg',
                                spacing: 'sm',
                                contents: [
                                    {
                                        type: 'box',
                                        layout: 'baseline',
                                        spacing: 'sm',
                                        contents: [
                                            {
                                                type: 'text',
                                                text: 'หมวดหมู่',
                                                color: '#aaaaaa',
                                                size: 'sm',
                                                flex: 2
                                            },
                                            {
                                                type: 'text',
                                                text: file.Category,
                                                wrap: true,
                                                color: '#666666',
                                                size: 'sm',
                                                flex: 5
                                            }
                                        ]
                                    },
                                    {
                                        type: 'box',
                                        layout: 'baseline',
                                        spacing: 'sm',
                                        contents: [
                                            {
                                                type: 'text',
                                                text: 'ขนาด',
                                                color: '#aaaaaa',
                                                size: 'sm',
                                                flex: 2
                                            },
                                            {
                                                type: 'text',
                                                text: `${fileSize} MB`,
                                                wrap: true,
                                                color: '#666666',
                                                size: 'sm',
                                                flex: 5
                                            }
                                        ]
                                    },
                                    {
                                        type: 'box',
                                        layout: 'baseline',
                                        spacing: 'sm',
                                        contents: [
                                            {
                                                type: 'text',
                                                text: 'วันที่',
                                                color: '#aaaaaa',
                                                size: 'sm',
                                                flex: 2
                                            },
                                            {
                                                type: 'text',
                                                text: uploadDate,
                                                wrap: true,
                                                color: '#666666',
                                                size: 'sm',
                                                flex: 5
                                            }
                                        ]
                                    }
                                ]
                            }
                        ]
                    },
                    footer: {
                        type: 'box',
                        layout: 'vertical',
                        spacing: 'sm',
                        contents: [
                            {
                                type: 'button',
                                style: 'primary',
                                height: 'sm',
                                action: {
                                    type: 'uri',
                                    label: 'ดาวน์โหลด',
                                    uri: file.DownloadURL
                                },
                                color: '#667eea'
                            },
                            {
                                type: 'button',
                                style: 'secondary',
                                height: 'sm',
                                action: {
                                    type: 'uri',
                                    label: 'ดูไฟล์',
                                    uri: file.URL
                                }
                            }
                        ],
                        flex: 0
                    }
                }
            };
        }

        // ==================== GLOBAL VARIABLES ====================
        let apiClient;
        let uploadManager;
        let fileManager;
        let liffManager;

        // ==================== INITIALIZATION ====================
        document.addEventListener('DOMContentLoaded', async () => {
            // Initialize API client
            apiClient = new ApiClient(CONFIG.SCRIPT_URL);
            
            // Test connection
            try {
                await apiClient.ping();
                console.log('API connection successful');
            } catch (error) {
                console.error('API connection failed:', error);
                Swal.fire({
                    title: 'เกิดข้อผิดพลาด',
                    text: 'ไม่สามารถเชื่อมต่อกับเซิร์ฟเวอร์ได้',
                    icon: 'error',
                    confirmButtonText: 'ตกลง'
                });
            }
            
            // Initialize managers
            uploadManager = new FileUploadManager(apiClient);
            fileManager = new FileManager(apiClient);
            liffManager = new LiffManager();
            
            // Initialize modal event listeners
            initializeModalEventListeners();
            
            // Initialize system if needed
            try {
                await apiClient.request('init');
            } catch (error) {
                console.warn('System initialization warning:', error);
            }
        });

        // ==================== MODAL EVENT LISTENERS ====================
        function initializeModalEventListeners() {
            // Close modals
            document.getElementById('closeModal')?.addEventListener('click', () => {
                document.getElementById('uploadModal').classList.add('hidden');
            });
            
            document.getElementById('closeDetailModal')?.addEventListener('click', () => {
                document.getElementById('fileDetailModal').classList.add('hidden');
            });
            
            // Click outside to close modals
            document.querySelectorAll('.modal-overlay').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.classList.add('hidden');
                    }
                });
            });
            
            // Settings button
            document.getElementById('settingsBtn')?.addEventListener('click', () => {
                showSettingsModal();
            });
        }

        // ==================== SETTINGS MODAL ====================
        function showSettingsModal() {
            Swal.fire({
                title: 'การตั้งค่า',
                html: `
                    <div class="text-left space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">URL ของ Google Apps Script</label>
                            <input type="text" id="scriptUrlInput" class="w-full px-3 py-2 border rounded-lg" value="${CONFIG.SCRIPT_URL}" placeholder="https://script.google.com/...">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">LIFF ID</label>
                            <input type="text" id="liffIdInput" class="w-full px-3 py-2 border rounded-lg" value="${CONFIG.LIFF_ID}" placeholder="1234567890-abcdefgh">
                        </div>
                        <div class="text-sm text-gray-500">
                            <p>• URL ของ Google Apps Script Web App</p>
                            <p>• LIFF ID สำหรับการเชื่อมต่อ LINE</p>
                        </div>
                    </div>
                `,
                showCancelButton: true,
                confirmButtonText: 'บันทึก',
                cancelButtonText: 'ยกเลิก',
                confirmButtonColor: '#667eea',
                preConfirm: () => {
                    const scriptUrl = document.getElementById('scriptUrlInput').value;
                    const liffId = document.getElementById('liffIdInput').value;
                    
                    if (!scriptUrl) {
                        Swal.showValidationMessage('กรุณาใส่ URL ของ Google Apps Script');
                        return false;
                    }
                    
                    return { scriptUrl, liffId };
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    CONFIG.SCRIPT_URL = result.value.scriptUrl;
                    CONFIG.LIFF_ID = result.value.liffId;
                    
                    // Reinitialize with new settings
                    location.reload();
                }
            });
        }

        // ==================== UTILITY FUNCTIONS ====================
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('th-TH', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function showNotification(title, message, type = 'info') {
            const Toast = Swal.mixin({
                toast: true,
                position: 'top-end',
                showConfirmButton: false,
                timer: 3000,
                timerProgressBar: true,
                didOpen: (toast) => {
                    toast.addEventListener('mouseenter', Swal.stopTimer);
                    toast.addEventListener('mouseleave', Swal.resumeTimer);
                }
            });

            Toast.fire({
                icon: type,
                title: title,
                text: message
            });
        }

        // ==================== ERROR HANDLING ====================
        window.addEventListener('error', (event) => {
            console.error('Global error:', event.error);
            showNotification('เกิดข้อผิดพลาด', 'มีข้อผิดพลาดเกิดขึ้นในระบบ', 'error');
        });

        window.addEventListener('unhandledrejection', (event) => {
            console.error('Unhandled promise rejection:', event.reason);
            showNotification('เกิดข้อผิดพลาด', 'การเชื่อมต่อขัดข้อง', 'error');
        });

        // ==================== KEYBOARD SHORTCUTS ====================
        document.addEventListener('keydown', (e) => {
            // Ctrl+U for upload
            if (e.ctrlKey && e.key === 'u') {
                e.preventDefault();
                document.getElementById('fileInput').click();
            }
            
            // Escape to close modals
            if (e.key === 'Escape') {
                document.querySelectorAll('.modal-overlay').forEach(modal => {
                    modal.classList.add('hidden');
                });
            }
            
            // Ctrl+R to refresh files
            if (e.ctrlKey && e.key === 'r') {
                e.preventDefault();
                fileManager.loadFiles();
                showNotification('รีเฟรช', 'รีเฟรชรายการไฟล์แล้ว', 'info');
            }
        });

        // ==================== SERVICE WORKER ====================
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('SW registered: ', registration);
                    })
                    .catch(registrationError => {
                        console.log('SW registration failed: ', registrationError);
                    });
            });
        }

        // ==================== PERFORMANCE MONITORING ====================
        window.addEventListener('load', () => {
            if ('performance' in window) {
                const loadTime = performance.timing.loadEventEnd - performance.timing.navigationStart;
                console.log(`Page load time: ${loadTime}ms`);
                
                if (loadTime > 3000) {
                    console.warn('Slow page load detected');
                }
            }
        });

        // ==================== RESPONSIVE HELPERS ====================
        function isMobile() {
            return window.innerWidth <= 768;
        }

        function adaptToScreenSize() {
            const container = document.querySelector('.container');
            if (isMobile()) {
                container.classList.add('px-2');
            } else {
                container.classList.remove('px-2');
            }
        }

        window.addEventListener('resize', adaptToScreenSize);
        adaptToScreenSize();

        // ==================== ACCESSIBILITY ====================
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Tab') {
                document.body.classList.add('keyboard-navigation');
            }
        });

        document.addEventListener('mousedown', () => {
            document.body.classList.remove('keyboard-navigation');
        });

        // Add focus styles for keyboard navigation
        const style = document.createElement('style');
        style.textContent = `
            .keyboard-navigation *:focus {
                outline: 2px solid #667eea !important;
                outline-offset: 2px !important;
            }
        `;
        document.head.appendChild(style);

        // ==================== DEBUG HELPERS ====================
        if (location.hostname === 'localhost' || location.hostname === '127.0.0.1') {
            window.debugMode = true;
            window.apiClient = () => apiClient;
            window.uploadManager = () => uploadManager;
            window.fileManager = () => fileManager;
            window.liffManager = () => liffManager;
            console.log('Debug mode enabled. Access managers via window.*Manager()');
        }

        // ==================== ANALYTICS (OPTIONAL) ====================
        function trackEvent(category, action, label = '') {
            console.log(`Analytics: ${category} - ${action} - ${label}`);
            // Implement your analytics tracking here
        }

        // Track file uploads
        document.addEventListener('fileUploaded', (e) => {
            trackEvent('File', 'Upload', e.detail.fileName);
        });

        // Track file downloads
        document.addEventListener('fileDownloaded', (e) => {
            trackEvent('File', 'Download', e.detail.fileName);
        });

        // Track file shares
        document.addEventListener('fileShared', (e) => {
            trackEvent('File', 'Share', e.detail.fileName);
        });
    </script>
</body>
</html>
